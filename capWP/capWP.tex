
%-------------------------------------------------------------
%				Studio in azienda
%-------------------------------------------------------------

\mcchap{Preparazione dell'ambiente di sviluppo per Wordpress}{cap:Preparazione dell'ambiente di sviluppo}

Wordpress, essendo un Content Management System open source, è altamente personalizzabile e dispone
di un innumerevole quantità di plugin, gratuiti e a pagamento, per ogni tipo di funzionalità.

Al mio arrivo veniva usata un'installazione base di Wordpress con la sola aggiunta di un plugin "Microsoft Azure 
for Wordpress" che fa in modo che tutte le immagini che vengono caricate su Wordpress dall'interfaccia web
vengono caricate e servite da un server di Microsoft Azure.

Questo serve principalmente, come accennato precedentemente, ad oscurare il dominio del server di Wordpress,
infatti se in una pagina del KN ci fossero linkate le immagini con l'indirizzo di Wordpress questo potrebbe 
comportare dei problemi di sicurezza.

Per iniziare i miei lavori su Wordpress era necessario impostare un ambiente di sviluppo e dei modi per automatizzare
la distribuzione delle modifiche.

Inoltre era necessario aggiungere un sistema di versionamento che fino a quel momento per Wordpress, a differenza
degli altri progetti, non veniva utilizzato.

\section{Architettura per lo sviluppo}

In 7Pixel per lo sviluppo di tutte le applicazioni viene usata la seguente architettura basata su tre macchine:
\begin{itemize}
\item {\bf Macchina di produzione}: è la macchina da cui vengono servite l'applicazione per l'utente finale.
\item {\bf Macchina di LAB}: è un ambiente identico a quello di produzione. Viene utilizzato per testare le nuove funzionalità
prima di venire deploiate in produzione.
\item {\bf Macchina di sviluppo}: è la macchina dove lavorano gli sviluppatori, non vengono usati dati reali per i prodotti, 
ma solo un numero ridotto di prodotti fake utili ai fini di testing
\end{itemize}

\section{Procedura di deploy}
Per la distribuzione delle modifiche si usa il seguente procedura
\begin{itemize}
\item {\bf Sviluppo in locale}: viene editato il codice per aggiungere una nuova funzionalità usando
TDD, una volta visto in locale che la funzionalità è stata implementata correttamente si passa alla fase successiva
\item {\bf Test in lab}: le nuove modifiche vengono deploiate in LAB, qui, sfruttando un ambiente simile a quello di 
produzione, vengono fatti ulteriori controlli, se si riscontra qualche problema si ritorna alla fase precedente e si corregge
altrimenti si passa alla fase successiva 
\item {\bf Deploy in produzione}: una volta effettuati i controlli in LAB le modifiche vengono pubblicate sulle macchine
di produzione e saranno disponibili agli utenti finali, nei minuti successivi si tiene sotto controllo {\bf New Relic}, un
applicazione di monitoraggio degli errori, per vedere se le modifiche pubblicate fanno generare degli errori inaspettati.
In caso di errori si fa "Revert" alla versione precedente altrimenti la nuova funzionalità viene considerata pubblicata con successo
\end{itemize}

Prima dei deploy, sia in LAB che in produzione, vengono fatti girare tutti i test, unitari e di integrazione, e il codice viene pubblicato solo se tutti questi sono "verdi".

\section{Impostazione della macchine di sviluppo}

Prima del mio arrivo il Team Iguana non si occupava dello sviluppo di Wordpress, non era quindi presente
nelle macchine di sviluppo locale.

è stato mio compito quindi, prima di iniziare a sviluppare, di installare su tutte le macchine di sviluppo
un istanza di Wordpress, servita dal server Nginx, lo stesso server già presente nelle macchine locali per
la reindirizzazione delle chiamate a Kiruby.

è stato poi creata un repository di git per il versionamento di Wordpress. In particolare è stata versionata
la cartella "wp-content", ovvero la cartella dove vengono effettuate le varie personalizzazioni

\section{Creazione dello script di deploy}
Lo script di deploy, essendo tutte la macchine macchine Linux, è stato scritto in un file eseguibile
"kirCMS-autodeploy.sh" utilizzando il linguaggio Bash ed utilizza una procedura simile allo script di deploy 
utilizzato da Kiruby.

Prima di eseguire il deploy è necessario fare commit sul master della repository di Wordpress.

Una volta committate le modifiche bisogna eseguire lo script "kirCMS-autodeploy.sh" passandogli come argomento
"lab" o "pro" a seconda della macchina su cui si vuole deploiare.

Lo script per prima cosa apre un tunnel verso la macchina dove si vuole deploiare e si collega a questo in remoto.

Una volta collegato in remoto viene scaricata da "Gitlab" l'ultima versione committata della repository dentro la cartella /tmp
e vengono eseguiti tutti i test di PhpUnit (eseguendo lo script "test.sh").

Se i test falliscono viene stampato a console un messaggio di errore e la procedura termina lasciando online
la versione precedente.

Se tutti i test passano la cartella scaricata in /tmp viene spostata dentro wordpress col nome wp-content ed inizierà
ad essere online, la precedente cartella wp-content viene rinominata come wp-content-bkp, la precedente cartella wp-content-bkp
viene eliminata.

La cartella wp-content-bkp serve a tenere ancora disponibile la versione precedente così, se vengono individuati
degli errori con il nuovo deploy, per ritornare alla situazione precedente è sufficente eliminare la cartella wp-content
e rinominare wp-content-bkp in wp-content.